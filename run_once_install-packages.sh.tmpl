#!/bin/bash

system_type=$(uname -s)

{{ if eq .chezmoi.os "linux" -}}
    if [ ! -f $HOME/.local/bin/micromamba ]; then
        PATH=$HOME/.local/bin:$PATH
        curl micro.mamba.pm/install.sh | bash
    fi
    source $HOME/.bashrc
    micromamba activate
    micromamba config prepend channels defaults
    micromamba config prepend channels bioconda
    micromamba config prepend channels conda-forge
    micromamba config prepend channels dnachun
    micromamba config set auto_activate_base true
    micromamba install --yes \
        archiver \
        aria2 \
        as-tree \
        atool \
        atuin \
        autoconf \
        autogen \
        automake \
        bash \
        bash-language-server \
        bat \
        bc \
        bingrep \
        binutils \
        bison \
        bottom \
        btop \
        breezy \
        broot \
        bzip2 \
        ccat \
        chezmoi \
        clangdev \
        cmake \
        code-minimap \
        conda-tree \
        coreutils \
        cpio \
        csview \
        curl \
        cvs \
        datamash \
        diffr \
        difftastic \
        diffutils \
        diff-so-fancy \
        diskonaut \
        diskus \
        dtrx \
        dua-cli \
        duf \
        dust \
        elvish \
        entr \
        exa \
        f2 \
        fcp \
        fd-find \
        file \
        flex \
        fselect \
        fzf \
        fzy \
        gawk \
        gcc \
        gdb \
        gfortran \
        gh \
        git \
        git-delta \
        global \
        gnupg \
        go \
        gotop \
        go-ghq \
        go-shfmt \
        grep \
        grex \
        groff \
        gxx \
        hstr \
        htop \
        hyperfine \
        inetutils \
        lazygit \
        less \
        lftp \
        lld \
        llvmdev \
        lsof \
        lzip \
        lzo \
        lzop \
        m4 \
        make \
        mamba \
        man-db \
        massren \
        melody \
        members \
        mercurial \
        meson \
        miller \
        moar \
        moreutils \
        murex \
        navi \
        ncdu \
        ncftp \
        neofetch \
        neovim \
        nomino \
        nsh \
        nushell \
        nvim \
        oh-my-posh \
        oil \
        ouch \
        openssh \
        p7zip \
        page \
        patch \
        patchelf \
        pax \
        pbzip2 \
        peco \
        percol \
        perl-ack \
        perl-app-cope \
        pget \
        pick \
        pipe-rename \
        pixz \
        plzip \
        pomsky \
        procs \
        procps-ng \
        pueue \
        py-spy \
        ranger-fm \
        rargs \
        rclone \
        ripgrep \
        ripgrep-all \
        rnr \
        rsync \
        ruff \
        rust \
        sd \
        sed \
        sheldon \
        shellcheck \
        shellharden \
        skim \
        smem \
        ssed \
        starship \
        subversion \
        sysstat \
        sysroot_linux-64=2.17 \
        tar \
        tealdeer \
        tectonic \
        texinfo \
        texlab \
        time \
        tmux \
        trash-cli \
        tre-command \
        tree \
        tuc \
        unar \
        up \
        unzip \
        util-linux \
        valgrind \
        viu \
        wget \
        which \
        xauth \
        xclip \
        xonsh \
        xz \
        yadm \
        zellij \
        zenith \
        zet \
        zip \
        zoxide \
        zsh
    # Do these after so they override conflicting files
    micromamba install --yes parallel rename
    micromamba shell init --shell zsh
    mamba init bash
    mamba init zsh
    conda config --set auto_stack 1
{{ end }}


{{ if eq .chezmoi.os "darwin" -}}
    if [ ! command -v brew &> /dev/null ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    #brew bundle install --file=$HOME/.local/share/chezmoi/Brewfile
    #micromamba shell init --shell zsh
    #mamba init zsh
    #conda config --set auto_stack 1
    #conda config --set auto_activate_base false
    # TODO iterm stuff
{{ end }}

# Install 
if [ ! -d $HOME/.local/share/zinit ]; then
    export NO_INPUT=1
    export NO_ANNEXES=1
    bash -c "$(curl --fail --show-error --silent --location https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh)"
    zsh -c "source $HOME/.zshrc; zinit update"
fi

if [ ! -d $HOME/.config/base16-shell ]; then
    git clone https://github.com/chriskempson/base16-shell.git $HOME/.config/base16-shell
fi

if [ ! -f $HOME/.local/share/nvim/site/autoload/plug.vim ]; then
    sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
    nvim '+PlugUpdate' '+PlugClean!' '+PlugUpdate' '+qall'
fi

if [ ! -d $HOME/.tmux/plugins/tpm ]; then
    git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm
fi

if [ ! -d $HOME/.config/ranger/plugins/ranger_devicons ]; then
    git clone https://github.com/alexanderjeurissen/ranger_devicons $HOME/.config/ranger/plugins/ranger_devicons
fi
